import firebase from "firebase/compat/app";
import "firebase/compat/firestore";

const firebaseConfig = {
    apiKey: "AIzaSyAe5Rb4dqi80cYUxj69EFr4AGElCI9Rb9o",
    authDomain: "meu-expansivo-app.firebaseapp.com",
    projectId: "meu-expansivo-app",
    storageBucket: "meu-expansivo-app.firebasestorage.app",
    messagingSenderId: "688981571362",
    appId: "1:688981571362:web:179c1dcae4b01f9f9f177b"
};

const app = firebase.initializeApp(firebaseConfig);
const db = app.firestore();

const SUBJECTS = [
    'Artes', 'Biologia', 'Ciências', 'Educação Física', 'Empreendedorismo',
    'Ensino Religioso', 'Espanhol', 'Filosofia', 'Física', 'Geografia',
    'História', 'Inglês', 'Literatura', 'Matemática', 'Musicalização',
    'Português', 'Projeto de Vida', 'Química', 'Redação', 'Sociologia'
];

const RAW_TEXT = `
223 24 ANTHONY MIGUEL GOMES BESSA 02 1A TARDE -
RUA PROFEVSESSOPERR MTIANNOO EL VILAR,197-NOSSA SENHORA DA
APRESENTAçãO/NATAL
07/01/2025
A 24/03/2019
6 24 ANTONIO MIGUEL DA SILVA
ANDRADE
02 1A MANHA -
MATUTINO
98836-9059/988155561
RUA GERMINO BENIGNO,798-NOSSA SENHORA DA
APRESENTAçãO/NATAL
14/01/2025
A 10/05/2019
486 24 BEATRIZ MENDONÇA GOMES 02 1A MANHA -
MATUTINO
84987194414- WILMA
RUA LUIZ MOURA,700-LAGOA AZUL/NATAL 29/01/2025
A 14/07/2018
520 24 BENICIO JOSE ANDRADE PESSOA
RIBEIRO
02 1A MANHA -
MATUTINO
99490 6547
RUA MARIA QUERINA,194 B-JARDINS SÃO GONÇALO/NATAL 08/02/2025
A 0
501 24 BERNARDO MOURA DE AZEVEDO 02 1A MANHA -
RUA GARIBMAALTDUIT RINOOM A N O,538-NOSSA SENHORA DA
APRESENTAçãO/NATAL
06/02/2025
A 02/11/2018
552 24 HEITOR MIGUEL DA SILVA
TAVARES
02 1A MANHA -
,-/ MATUTINO 21/05/2025
A 20/10/2018
296 24 JOÃO VICTOR PINHEIRO DE LIMA 02 1A MANHA -
MATUTINO
84 991295959
RUA MANOEL PATRICIO DE MEDEIROS ,2100-JARDINS/SÃO
GONÇALO DO AMARANTE
08/02/2025
A 22/08/2018
102 24 LUCAS GABRIEL BARROS DA
FRANÇA LIMA
02 1A MANHA -
MATUTINO
999223315/991240746
RUA DOM PEDRO II,405-JARDINS/SãO GONçALO DO AMARANTE 08/02/2025
A 30/01/2019
538 24 MALU AGATHA ALVES CRUZ 02 1A MANHA -
MATUTINO
98796 1389
RUA SANTA INACIO DE LOWOLA,94-IGAPO/NATAL 07/03/2025
A 28/01/2019
50 24 MARIA ALICE DE SOUSA E LIMA 02 1A MANHA -
MATUTINO
8499915-2501 MAE
TRAVESSA MARANGUAPE,411-NOSSA SENHORA DA
APRESENTAçãO/NATAL
15/01/2025
A 02/08/2018
469 24 MARIANA FERREIRA DE OLIVEIRA 02 1A MANHA -
RUA SANTAM LAUTZUITAI N,1O0 4 6 -IGAPO /NATAL 22/01/2025
A 17/09/2018
316 348 PEDRO RIBEIRO DA SILVA NETO 02 1A MANHA -
TRAVESSAM SAATNUTTAIRNéOM , 1 6-NOSSA SENHORA DA
APRESENTAçãO/NATAL
21/03/2025
A 05/10/2018
339 24 RICKSON GUILHERME PIRES DE
OLIVEIRA
02 1A MANHA -
RUA COUTMOA MTAUGTIANLOH ã E S,195-NOSSA SENHORA DA
APRESENTAçãO/NATAL
05/02/2025
A 28/08/2018
29 24 SASHA SUYANNE SIQUEIRA
FERNANDES
02 1A MANHÃ -
MATUTINO
988102375
RUA DAS PETúNIAS,61A-NOSSA SENHORA DA
APRESENTAçãO/NATAL
10/01/2025
A 22/06/2018
374 24 CHRISTIAAN GAEL DE SOUZA
DANTAS
02 1A MANHA -
MATUTINO
84 98631 6698
RUA DA LIBERDADE,185-NOSSA SENHORA DA
APRESENTAçãO/NATAL
09/12/2024
B 01/03/2019
461 24 ENZO CAUA ARAUJO DE ANDRADE 02 1A TARDE -
VESPERTINO
99217 1198
RUA JOSE SOBRINHO ,10-NSA DA APRESENTAÇÃO/NATAL 20/01/2025
B 14/04/2018
555 24 ENZO GABRIEL DA SILVA COSTA 02 1A TARDE -
RODOVIA BVRES-1P0E1R,T4I2N2O4 -JARDINS/SãO GONçALO DO AMARANTE 10/06/2025
B 28/09/2017
51 24 JOSÉ RICARDO FERNANDES DA S. E
MEDEIROS
02 1A TARDE -
VESPERTINO
84 98864-7165
AVENIDA MARANGUAPE,4963-NOSSA SENHORA DA
APRESENTAçãO/NATAL
26/12/2024
B 07/11/2018
88 24 LIVIA VENANCIO DE OLIVEIRA 02 1A TARDE -
VESPERTINO
9843-2946/9831-0569
RUA MANOEL PATRíCIO DE MEDEIROS,2100-JARDINS/SãO
GONçALO DO AMARANTE
21/02/2025
B 22/11/2018
460 24 LUNNA SOPHIE DE ALMEIDA
RODRIGUES
02 1A TARDE -
VESPERTINO
91 980246048
AV BAHIA,2022-POTENGI/NATAL 17/01/2025
B 04/03/2019
554 24 MARIA SOFIA CAVALCANTE ALVES 02 1A TARDE -
RUA FLOR VDEES JPúEPRITTIENRO,1 05-NOSSA SENHORA DA
APRESENTAçãO/NATAL
09/06/2025
B 13/03/2019
103 24 MIGUEL BRYAN PEREIRA ROCHA 02 1A TARDE -
VESPERTINO
987317979/986330330
TRAVESSA JOSé LUIZ DA SILVA,6-NOSSA SENHORA DA
APRESENTAçãO/NATAL
07/02/2025
B 30/07/2018
23 24 ADRIAN MANOEL ALVES DA SILVA
OLIVEIRA
02 2A MANHA -
MATUTINO
9872424047/994009218
RUA RIO DOS SINOS,388-NOSSA SENHORA DA
APRESENTAçãO/NATAL
24/02/2025
A 11/03/2018
39 24 ANTONNY LEVY SANTOS DA COSTA 02 2A MANHA -
MATUTINO
987554713/987192885
RUA PROFESSOR MANOEL VILAR,230-NOSSA SENHORA DA
APRESENTAçãO/NATAL
29/01/2025
A 21/11/2017
299 24 ARLEAN DO NASCIMENTO ARAUJO 02 2A MANHA -
RUA JOANAM AETLIUSTAIN FOE R N ANDES,688-NOSSA SENHORA DA
APRESENTAçãO/NATAL
03/02/2025
A 08/06/2017
518 24 BENJAMIM NAIRON NASCIMENTO
FERNANDES
02 2A MANHA -
RUA PRESIDMEANTTUET IMNAOS C ARENHAS ,355-QUINTAS /NATAL 07/02/2025
A 01/03/2017
521 24 DAVI NICHOLAS CAVALCANTE DE
SOUZA
02 2A MANHA -
RUA JOSé MMAATUURTíCINIOO D E MACEDO,26-NOSSA SENHORA DA
APRESENTAçãO/NATAL
08/02/2025
A 06/07/2017
511 24 ELOÁ LOPES DOS SANTOS 02 2A MANHA -
MATUTINO
84987619097
RUA MARIA DO SOCORRO DE AZEVEDO
MACHADO,68-GUAJIRU/SãO GONçALO DO AMARANTE
07/02/2025
A 03/05/2018
12 24 ENZO MIGUEL ARAUJO DE
OLIVEIRA
02 2A MANHA -
,-/ MATUTINO 11/02/2025
A 17/11/2017
325 24 HEITOR OLIVEIRA DE MEDEIROS 02 2A MANHA -
RUA ROSIMMAART UFTEIRNROE I R RA,46-NOSSA SENHORA DA
APRESENTAçãO/NATAL
20/01/2025
A 01/12/2017
147 24 HELENA SOPHIA DA SILVA
MARCOLINO
02 2A MANHA -
MATUTINO
8893-1125/9638-0353
RUA VALE DO CARIRI,57-NOSSA SENHORA DA
APRESENTAçãO/NATAL
28/01/2025
A 19/09/2017
499 24 ISLA VITORIA RODRIGUES
MOREIRA
02 2A MANHA -
MATUTINO
99196 2593
RODOVIA BR 101 ,4224-SÃO GONÇALO/SÃO GONÇALO DO
AMARANTE
06/02/2025
A 04/04/2017
154 24 JENNIFER HELOISA DA SILVA
FERNANDES
02 2A MANHA -
RUA SãO JMOAãOTU DTOIN MOE R ITI,2341-POTENGI/NATAL 25/01/2025
A 16/06/2017
92 24 JÚLIA TEREZA DA SILVA ARAÚJO 02 2A MANHA -
RODOVIA BMRA-T1U0T1I,N4O22 4 -JARDINS/SãO GONçALO DO AMARANTE 10/01/2025
A 30/03/2018
219 24 KAUÊ MIGUEL SOUZA DA SILVA 02 2A MANHA -
MATUTINO
84 9 88109986
,-/ 14/01/2025
A 01/03/2018
96 100 LUIZ BENICIO MANIÇOBA DE LIMA 02 2A TARDE -
RUA GADEVLHESAP,1E0R0T-INNOOS SA SENHORA DA APRESENTAçãO/NATAL 14/01/2025
A 11/07/2017
137 24 LUIZ MANUEL QUEIROZ DE
OLIVEIRA
02 2A MANHA -
MATUTINO
986400663/987398403
RUA FRANCISCA LINDALVA DE SOUZA,48-JARDINS/SãO
GONçALO DO AMARANTE
14/01/2025
A 12/01/2018
470 24 MANUELA FERREIRA DE OLIVEIRA 02 2A MANHA -
RUA SANTAM LAUTIUZTAI N,1O4 6 - IGAPO/NATAL 22/01/2025
A 10/06/2017
421 24 MARIA HELENA DOS SANTOS LEÃO 02 2A TARDE -
VESPERTINO
99914 2454
ROD BR 101 4224,-JARDINS/SÃO GONÇALO 06/01/2025
A 11/03/2018
113 24 NICOLAS DANTE TAVARES TORRES 02 2A MANHA -
MATUTINO
991137877/988320060
AVENIDA BOA SORTE,-NOSSA SENHORA DA
APRESENTAçãO/NATAL
10/02/2025
A 11/03/2018
224 24 RYAN ALEXANDER SILVA MARINHO 02 2A MANHA -
MATUTINO
98762-3957
,-/ 07/02/2025
A 15/07/2017
91 24 URIEL LEVI DOS SANTOS
MARREIRO
02 2A MANHA -
MATUTINO
8748-8538/8785-0478
TRAVESSA JOSé LUIZ DA SILVA,27-NOSSA SENHORA DA
APRESENTAçãO/NATAL
27/12/2024
A 14/01/2018
140 145 VALENTINA THORRYCCELEE
SILVEIRA DE SANTA
02 2A MANHA -
MATUTINO
988180110/994556717
RUA JOSé LUíS DA SILVA,617-NOSSA SENHORA DA
APRESENTAçãO/NATAL
09/01/2025
A 24/03/2018
38 24 ANTHONY RHAVI INÁCIO DA SILVA 02 2A TARDE -
VESPERTINO
999033757/996998788
RUA JOSé DE PAIVA TORRES,220-OLHO D'AGUA/SãO GONçALO
DO AMARANTE
17/01/2025
B 06/12/2017
379 24 ELOA JUSTINO PORPINO
RODRIGUES
02 2A MANHA -
RUA GRAVMATAATIU,2T7IN2O5- P O TENGI/NATAL 10/12/2024
B 01/08/2017
345 402 PENELLOPY MARIA DE LIMA 02 2A TARDE -
TV IMPERIAVLE ,S5P6E-RNTOISNSOA SENHORA DA AP/NATAL 27/12/2024
B 01/04/2017
94 24 WYLHAN MATTHEW DE PAIVA SILVA 02 2A TARDE -
VESPERTINO
98606-9087/
RUA SãO FRANCISCO,276-NOSSA SENHORA DA
APRESENTAçãO/NATAL
08/01/2025
B 24/08/2017
116 24 ALICE AYLLA RODRIGUES DE O.
CARDOSO
02 3A MANHA -
MATUTINO
994050001/998644191
AVENIDA SENADOR CARLOS ALBERTO,650-NOSSA SENHORA DA
APRESENTAçãO/NATAL
27/01/2025
A 04/03/2017
320 24 ALLANA STHER SILVA ARAUJO 02 3A MANHA -
RUA ODILOMNA TFUERTIRNEOIR A ,23-NOSSA SENHORA DA
APRESENTAçãO/NATAL
20/12/2024
A 09/01/2016
529 24 BIANCA MARQUES RODRIGUES 02 3A MANHA -
,-/ MATUTINO 17/02/2025
A 07/04/2017
17 24 CAROLINE GAMA MEDEIROS 02 3A MANHA -
MATUTINO
996567897/996123804
RUA JOANA ELISA FERNANDES,1199-NOSSA SENHORA DA
APRESENTAçãO/NATAL
16/12/2024
A 12/06/2016
480 24 ENZO FERNANDES PAIVA DE MELO 02 3A TARDE -
VESPERTINO
99616 4780
RUA LAGOA MUNDAU,1378-POTENGI/NATAL 28/01/2025
A 13/05/2016
222 24 ISADORA LIRA DA SILVA 02 3A MANHA -
MATUTINO
8882-9633/9201-6074
RUA HELENA RODRIGUES DE FREITAS,257-SANTO ANTôNIO DO
POTENGI/SãO GONçALO DO AMARANTE
17/01/2025
A 10/06/2016
524 24 ISMAEL FELIPE AZEVEDO
FERNANDES
02 3A MANHA -
RUA NOVO MOARTIEUNTITNEO , 1 1 3-NOSSA SENHORA/NATAL 10/02/2025
A 08/08/2015
171 24 JÚLIO CESAR DA SILVA OLIVEIRA 02 3A MANHA -
MATUTINO
8871-7452/8865-9195
RUA SEBASTIãO GONçALVES,14-IGAPó/NATAL 22/01/2025
A 13/06/2016
33 24 LARISSA GABRIELA DA SILVA
BARBOSA
02 3A MANHA -
MATUTINO
991216722/987179065
RUA JOSé LUíS DA SILVA,416-NOSSA SENHORA DA
APRESENTAçãO/NATAL
06/02/2025
A 13/04/2017
471 24 MIKAEL RENAN SILVA LUCAS
TEIXEIRA
02 3A MANHA -
RUA VITóRMIAA TRUéTGIINAO,1 9 9-NOSSA SENHORA DA
APRESENTAçãO/NATAL
23/01/2025
A 14/04/2015
458 24 MURILO GABRIEL NASCIMENTO
ARAÚJO
02 3A MANHA -
TRAVESSA MAMATAUZTOINNIOA , 9 59-/ 17/01/2025
A 26/08/2016
378 24 NATHALY CRISTINE MONTEIRO
BARBOSA MOREIR
02 3A MANHA -
RUA NOVA MIGAUTAUÇTUIN ,O2 9 2 9-POTENGI /NATAL 10/12/2024
A 10/07/2016
28 29 NICOLY DAYSE SILVA DE LIMA 02 3A MANHA -
MATUTINO
986000042/988250434
TRAVESSA SANTA FERNANDA,67-NOSSA SENHORA DA
APRESENTAçãO/NATAL
27/12/2024
A 07/06/2016
533 24 NOEMI VITÓRIA DE SOUZA
FERREIRA
02 3A MANHA -
MATUTINO
84988063602
RUA PIRAI DO NORTE,90-NOSSA SENHORA DA
APRESENTAÇAO/NATAL
18/02/2025
A 12/02/2017
344 24 RAFAEL GURGEL ALVES 02 3A MANHA -
AVENIDA RMIAOT DUOTICNEO,1 1 61-POTENGI/NATAL 31/01/2025
A 17/04/2016
397 24 VITORIA OLIVEIRA DE MOURA
SILVA
02 3A MANHA -
MATUTINO
98701 8216
RUA TANGARA DA SERRA ,206-PQ DOS COQUEIRO/NATAL 26/12/2024
A 30/11/2016
\`;

function parseStudents(text) {
    const students = [];
    const content = text.replace(/\\r/g, '').split('\\n').join(' ');
    const studentRegex = /(\\d{1,4})\\s+(\\d{1,3})\\s+([A-Z\\xC0-\\xFF\\s\\n\\-]{5,100}?)\\s+(01|02)\\s+(N[1-5]|[1-9][AB S]?|(?:\\d+º\\s+Ano))\\s+(MANHA|TARDE|MATUTINO|VESPERTINO|TARDE-VESPE|TARDE-VESPERTINO|MANHÃ)/g;

    let match;
    while ((match = studentRegex.exec(content)) !== null) {
        let [full, code, ref, name, anchor, grade, shiftRaw] = match;
        const shift = (shiftRaw.includes('MANHA') || shiftRaw.includes('MATUTINO') || shiftRaw.includes('MANHÃ')) ? 'Matutino' : 'Vespertino';
        const nextPart = content.substring(match.index + full.length, match.index + full.length + 300);
        const classMatch = nextPart.match(/\\s+([AB])\\s+\\d{2}\\/\\d{2}\\/\\d{4}/);
        const schoolClass = classMatch ? classMatch[1] : 'A';

        students.push({
            code,
            name: name.trim().replace(/\\s+/g, ' '),
            gradeSigla: grade.toUpperCase(),
            shift,
            schoolClass
        });
    }
    return students;
}

function translateGrade(sigla) {
    const infantilMap = {
        'N1': 'Nível I - Edu. Infantil',
        'N2': 'Nível II - Edu. Infantil',
        'N3': 'Nível III - Edu. Infantil',
        'N4': 'Nível IV - Edu. Infantil',
        'N5': 'Nível V - Edu. Infantil'
    };
    if (sigla.startsWith('N')) return infantilMap[sigla] || sigla;
    if (/^\\d/.test(sigla)) {
        const num = parseInt(sigla.match(/^\\d+/)[0]);
        if (sigla.includes('S')) return \`\${num}ª Série - Ens. Médio\`;
        if (num >= 1 && num <= 5) return \`\${num}º Ano - Fundamental I\`;
        return \`\${num}º Ano - Fundamental II\`;
    }
    return sigla;
}

async function startImport() {
    console.log("Starting Firebase script...");
    const parsed = parseStudents(RAW_TEXT);
    console.log(\`Parsed \${parsed.length} students.\`);

    for (const data of parsed) {
        const gradeLevel = translateGrade(data.gradeSigla);
        const studentId = \`student_\${data.code}\`;
        
        const student = {
            id: studentId,
            code: data.code,
            name: data.name,
            password: '123',
            gradeLevel,
            gradeLevelSigla: data.gradeSigla,
            shift: data.shift,
            schoolClass: data.schoolClass,
            unit: 'Boa Sorte',
            isBlocked: false,
            nome_responsavel: '',
            metodo_pagamento: 'Interno'
        };

        try {
            await db.collection('students').doc(studentId).set(student);
            console.log(\`[OK] \${student.name} (\${student.gradeLevel})\`);

            const isInfantilBySigla = data.gradeSigla.startsWith('N');
            const isInfantilByName = gradeLevel.includes('Infantil') || gradeLevel.includes('Nível');
            
            if (isInfantilBySigla || isInfantilByName) {
                const gradesSnap = await db.collection('grades').where('studentId', '==', studentId).get();
                if (!gradesSnap.empty) {
                    console.log(\`   -> [CLEANUP] Removing \${gradesSnap.size} subjects for Infantil.\`);
                    const batch = db.batch();
                    gradesSnap.docs.forEach(doc => batch.delete(doc.ref));
                    await batch.commit();
                }
            } else {
                const now = new Date().toISOString();
                for (const subject of SUBJECTS) {
                    const gradeId = \`\${studentId}_\${subject.replace(/\\s+/g, '_')}\`;
                    await db.collection('grades').doc(gradeId).set({
                        id: gradeId,
                        studentId,
                        subject,
                        bimesters: {
                            bimester1: { nota: null, recuperacao: null, media: 0, faltas: 0 },
                            bimester2: { nota: null, recuperacao: null, media: 0, faltas: 0 },
                            bimester3: { nota: null, recuperacao: null, media: 0, faltas: 0 },
                            bimester4: { nota: null, recuperacao: null, media: 0, faltas: 0 }
                        },
                        mediaAnual: 0,
                        mediaFinal: 0,
                        situacaoFinal: 'Recuperação',
                        lastUpdated: now
                    }, { merge: true });
                }
                console.log(\`   -> [GRADES] 20 subjects guaranteed.\`);
            }
        } catch (e) {
            console.error(\`[ERROR] \${data.name}:\`, e);
        }
    }
    console.log("Done.");
    process.exit(0);
}

startImport().catch(err => {
    console.error("CRITICAL ERROR:", err);
    process.exit(1);
});
